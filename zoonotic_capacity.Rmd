---
title: "zoonotic_capacity"
output: html_document
---

```{r setup try2, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::knit("zoonotic_capacity.Rmd", output = "html_document")
```


#####install packages
```{r packages, include = FALSE}

library(tidyr)
print(Sys.time())
pkgTest <- function(x)
{
  if (x %in% rownames(installed.packages()) == FALSE) {
    install.packages(x, dependencies= TRUE, repos='http://cran.us.r-project.org')    
  }
  library(x, character.only = TRUE)
}
neededPackages <- c( "ggplot2",  "plyr", "foreach","broom", "remotes", "stringr",  "data.table",  "Hmisc", "caret", "ggforce",  "gbm", "caret", "Matrix", "pdp", "caTools", "ROCR", "dplyr", "dismo", "doSNOW",  "tidyverse",  "patchwork", "gtable", "magrittr",  "fulltext",  "operator.tools", "stringi", "tidyr", "knitr")
for (package in neededPackages){pkgTest(package)}

```

#folders -- create output and figure folders and delete files in them if they already exist
```{r folder}
mainDir = c("output", "figure")
for (a in 1:length(mainDir)){
  if (!dir.exists(file.path(mainDir[a]))){
    dir.create(file.path(mainDir[a]))
  } else { 
    list_files = list.files(mainDir[a])
    file.remove(paste0(mainDir[a], "/", list_files))
  }  
}

performance_out = NULL#this will store performance metrics
save(performance_out, file = "output/performance_out.Rdata")

pred_sum_out = NULL
save(pred_sum_out, file = "output/pred_sum_out.Rdata")

```

##cores
```{r, include = FALSE}
cores = 4#check this is no more than half the number of cores available
cl <- makeCluster(cores, "SOCK", timeout = 60)  
registerDoSNOW(cl)

#if getting error related to dopar, nodes
# stopCluster(cl)
# rm(cl)
  
```

##zoonotic capacity, mammals, include only wild species in training data
```{r wild_only -129_imputed zoonotic capacity}
source("code/remove_temp_data.R")
##do analysis, mammals, imputed, wild only, haddock_infected_and_below (-129), include forstrat
source("code/wild_only_zoonotic_capacity_include_forstrat_conservative_deviance_2.R")

#define hyperparameters based on best test AUC for parameter set that has good deviance curve
source("code/R_run_gridSearch.R") 
source("code/deviance_plots_all.R")#examine plots
#look at, only eta 0.0001 has okay curves
hyper_grid = subset(hyper_grid, eta == 0.0001)
#choose the best parameters (highest AUC w/ also good deviance curve)
eta = 0.0001
max_depth = 2
n.minobsinnode = 5

source("code/deviance_plot_defined.R")
##run scripts
source("code/scripts.R")
##now do one shot of making predictions with all of the available data and with the same set of hyperparameters as used in "conservative_depth_2"
source("code/wild_only_zoonotic_capacity_include_forstrat_cons_dev_2_one_iteration.R")
source("code/run_bootstrapGBM_predictions_one_iteration.R")
```

##do analysis, mammals, imputed, wild and non-wild, haddock_infected_and_below (-129)
```{r wild_non_wild_zoonotic_capacity}
source("code/wild_non_wild_zoonotic_capacity.R")
```

##mammals, imputed, haddock_score_mean
```{r mammals_haddock.R}
source("code/mammals_haddock.R")
```

##mammals, imputed, AA_30_negative
```{r mammals, imputed, AA_30_negative}
source("code/mammals_AA_haddock.R")
```

##vertebrates, zoonotic capacity
```{r vertebrates_zoonotic_capacity.R}
source("code/vertebrates_zoonotic_capacity.R")
```

##vertebrates, haddock_score_mean
```{r vertebrates_haddock.R}
source("code/vertebrates_haddock.R")
```

##vertebrates, AA 30
```{r vertebrates_AA_haddock.R}
source("code/vertebrates_AA_haddock.R")
```

##write outputs -- performance_out and DF_merge_out
```{r performance}
source("code/remove_temp_data.R")
load("output/performance_out.Rdata")
load("output/pred_sum_out.Rdata")
write.csv(performance_out, paste0("output/performance_models", ".csv"))
save(pred_sum_out, file = "output/pred_sum_out.Rdata")
```

##find out how long it takes to run
```{r}
print(Sys.time())
```

